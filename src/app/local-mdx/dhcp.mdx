## 학교 와이파이에 접속할 때마다 IP가 바뀐다

"바뀌는 게 문제일까, 아니면 당연한 걸까?"

<img
  src = "https://donghyeun-blog-images.s3.us-east-1.amazonaws.com/server_timeout.png"
  width = "600px"
/>

며칠 전, 학교에서 네이버 클라우드 교육을 듣다가 서버 접속 과정에서 타임아웃이 떴었다. <br />
어제까지만 해도 잘 접속되던 서버가 갑자기 들어가지지 않는 것이다.

**"어제는 멀쩡했는데... 그새 서버가 죽었나?"** <br />
같은 강의실에서, 같은 와이파이였으니 처음에는 당연히 서버 쪽 문제라고 생각했다.

근데 서버 보안그룹 인바운드 규칙에서 'My IP'를 눌러보니, **IP 주소가 바뀌어 있었다.** <br />
어제와는 다른 IP 값이었다.

그 후로 맨날 IP는 바뀌었고, 이게 대체 왜 이러는 걸까 궁금하기 시작했다.

---

## IP는 "집 주소"와 같은 개념인가?

흔히 IP를 집 주소에 빗대어서 생각하곤 한다. <br />
한 번 정하면 그대로 유지되는 것처럼.

하지만 학교, 공공기관, 기업 네트워크에서는 IP는 고정된 주소가 아니라 **"잠깐 붙여주고 떼는 주소"** 에 가깝다.

- 네트워크에 접속 -> IP 하나 받음.
- 연결 종료 -> IP 반납
- 다음에 접속 -> 같은 IP 일 수도 있고, 아닐 수도 있음.

네트워크 입장에서 중요한 건, <br />
**"접속하는 사람이 누구인 지"보다 "어디서 접속을 한 건지"에** 더 가깝다.

그래서 학교같이 사용자가 계속 이동하는 환경에선 **IP가 바뀌는 게 오히려 더 자연스러운 것**이다.

---

## DHCP, 자동 IP 할당의 기본 메커니즘

그러면 과연 이 IP는 누가 나눠주는 걸까?

<img
  src = "https://donghyeun-blog-images.s3.us-east-1.amazonaws.com/dhcp.jpg"
  width = "600px"
/>

대부분의 학교, 기관망에서는 DHCP를 사용해 IP를 자동으로 배정한다.

DHCP는 다음과 같이 동작된다.

1. 클라이언트가 네트워크에 접속하면서 **DHCP Discover** 브로드캐스트 요청을 보냄.
2. DHCP 서버가 응답으로 **DHCP Offer** (사용 가능한 IP 제안)을 보냄.
3. 클라이언트가 Offer 받은 IP를 요청하는 **DHCP Request** 메시지를 보냄.
4. 서버가 최종 승인으로 **DHCP ACK**을 보내며 IP와 네트워크 설정을 전달.

```
기기 : 저 네트워크 쓸게요 !
DHCP 서버 : 넹, 이 IP 쓰세요. 시간 지나면 반납하시구요.
```

이런 4단계 과정(DORA)을 통해, 
기기마다 고정 IP를 일일이 설정할 필요 없이
자동으로, 그리고 동적으로 IP를 부여받을 수 있다.

또한, DHCP가 할당해 주는 IP는 "임대(lease)" 개념이다. <br />
즉, 그 IP를 영구 할당받는 건 아니며,
일정 시간이 지나면 반납되거나 갱신되어,
다른 기기에 넘어갈 수 있다.

이 때문에, 유동 IP(Dynamic IP) 방식에서는
기기가 네트워크에 접속할 때마다 같은 IP를 받는 것이 보장되지 않는다.

> 결국, DHCP의 핵심은 **"필요할 때 잠깐 빌려 쓰는 주소 체계"** 라는 것이다.

---

## 학교, 기관에서 IP가 유독 자주 바뀌는 이유

- 접속하는 기기가 매우 많고 수시로 바뀐다.
- 사람과 기기가 자주 이동한다.
- 네트워크 구성과 관리 부담을 줄여야 한다.
- 사용자가 많아, 모두에게 고정 IP를 줄 수는 없다.

이럴 때는, 고정 IP보다 **동적 IP + DHCP + IP 재활용 방식**이 훨씬 효율적이고 현실적이다.

뿐만 아니라, 네트워크 관리자의 입장을 생각해 보면

- IP 주소 풀을 중앙에서 관리하고 재활용 가능
- IP 고정 설정에 따른 오류 / 관리를 피할 수 있다.
- 한정된 IP 리소스를 절약하면서 더 많은 기기를 수용할 수 있다.

즉, 내 노트북에서 IP가 바뀌었다는 건 "대규모 환경에 맞춘 네트워크 설계"인 것이다 !

---

## 그러면 내부 네트워크 구조는 어떨까?

```
[노트북] → [AP] → [건물 스위치] → [코어 스위치] → [DHCP 서버]
                            ↘  [VLAN 별 IP 풀]
```

각 VLAN마다 범위가 다르다.

- IT관 1층 : 10.1.0.x
- IT관 2층 : 10.1.12.x
- 도서관 : 10.40.x.x

같은 건물이라도 층만 달라져도 IP 대역은 달라진다. <br />
그러니 IP가 바뀌는 건 설계된 대로 잘 작동되는 것이었다.

---

## 내부 IP가 바뀌면 '공인 IP'도 바뀔 수 있다고

여기서 한 가지를 더 짚고 넘어가야 한다.

클라우드 보안 그룹에서 보이는 "내 IP"는
내 노트북의 사설 IP가 아니라 학교 밖으로 나갈 때 사용하는 공인 IP(Public IP)이다.

그리고 학교망에서는 VLAN이 달라지거나 다른 게이트웨이(NAT 장비)를 거치면
외부에서 보는 내 공인 IP가 달라질 수 있다.

즉, 
- 내부 IP가 DHCP에 의해 바뀌고
- NAT 경로가 달라지면서
- 결국 외부에서 보는 IP도 바뀌게 된다.

그래서 다음 날에 보안 그룹에서 My IP를 눌러보면 달라지는 것이다.

> 내부 IP 변화 + NAT 변화 = 보안 그룹에서 보이는 IP 변화

---

## 고정 IP보다 유동 IP가 더 안전한 이유

내가 생각하기엔 고정 IP가 더 안전하지 않나라는 의문이 생기긴 한다.

하지만 기관망 보안은 IP 고정보단 
사용자 인증 + 접속 로그가 몇 배는 더 중요하다.

- 고정 IP는 관리가 복잡하고 추적도 어렵다.
- 유동 IP는 DHCP 로그 + 인증로그로 "누가 어디서 무엇을 했는지"를 확인할 수 있다.
- 악성 사용자가 동일 IP를 계속 쓰는 것도 막을 수 있다.

즉, 보안 관점에서도 IP는 주기적으로 바뀌는 게 정상적이고 유리하다.

---

## 그러면 DHCP를 썼을 때 주소 충돌이 나면 어떡하지..

<img
  src = "https://donghyeun-blog-images.s3.us-east-1.amazonaws.com/ip_conflict.png"
  width = "600px"
/>

근데 이렇게 IP를 자동으로 막 나눠주다 보면, 혹시 중복된 주소를 줘서 충돌이 나지는 않을까? 라는 의문이 든다.

DHCP 서버는 내부적으로 IP 풀을 가지고 있고,

- 어떤 IP가 누구에게 임대(lease) 되었는지
- 어떤 IP는 사용 중인지
- 어떤 IP는 예약인지

이런 걸 모두 기록한다고 한다.

그리고 이미 임대된 주소는 절대로 다시 주지 않는 방식으로 동작한다. <br />
그래서 **이론상 충돌이 생기지 않는 게 당연하다 !**

---

## 마무리

결론적으로, 학교나 기관에서 IP가 바뀌는 건 불안정한 네트워크가 아니라
그 네트워크가 설계된 방식 그대로 아주 잘 작동되고 있는 것이었다.

많은 사용자, 제한된 IP 자원, 효율적 관리 등을 고려했을 때 가장 만족스러운 방식이 바로 유동 IP + DHCP 구조인 것이다.