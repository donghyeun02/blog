2024ë…„ 6ì›”, ì½”ë ˆì¼ í™ˆí˜ì´ì§€ê°€ ëŒ€ëŒ€ì ìœ¼ë¡œ ë¦¬ë‰´ì–¼ë˜ë©´ì„œ ê¸°ì¡´ ìë™ ì˜ˆë§¤ ì½”ë“œê°€ ë” ì´ìƒ ë™ì‘í•˜ì§€ ì•Šê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤.  
[ì´ì „ ê¸€](https://velog.io/@bandh/ktx-%EC%9E%90%EB%8F%99-%EC%98%88%EB%A7%A4)ì—ì„œ ì†Œê°œí–ˆë˜ ë°©ì‹ì´ ë§‰íˆë©´ì„œ, ìƒˆë¡­ê²Œ êµ¬ì¡°ë¥¼ ëœ¯ì–´ê³ ì¹˜ê³ , ìµœì‹  Seleniumê³¼ Spring Bootë¡œ ë‹¤ì‹œ êµ¬í˜„í–ˆìŠµë‹ˆë‹¤.

<img
  src="https://donghyeun-blog-images.s3.us-east-1.amazonaws.com/korailreserve.gif"
  width="800"
/>

## ì£¼ìš” ë³€ê²½ì 

- **í™ˆí˜ì´ì§€ êµ¬ì¡° ë³€í™”** : React ê¸°ë°˜ ëª¨ë‹¬, ë™ì  ë¡œë”©, ë²„íŠ¼ í´ë˜ìŠ¤ëª… ë³€ê²½ ë“±ìœ¼ë¡œ ì¸í•´ ê¸°ì¡´ ì…€ë ‰í„°ê°€ ëª¨ë‘ ë¬´íš¨í™”ë¨.
- **ì½”ë“œ êµ¬ì¡° ë¦¬íŒ©í† ë§** : MVC íŒ¨í„´ì— ë§ì¶° Controller/Service/Utilë¡œ ë¶„ë¦¬, ê° ì—­í• ë³„ ì±…ì„ ëª…í™•í™”
- **íŒì—…/ëª¨ë‹¬ ì²˜ë¦¬** : íŒì—…ì´ ì™„ì „íˆ ì‚¬ë¼ì§ˆ ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¬ëŠ” ë¡œì§ ì¶”ê°€, JavaScript í´ë¦­ í™œìš©
- **Safari/Chrome ë“œë¼ì´ë²„** : SafariDriver, ChromeDriver ì‚¬ìš©

## ì½”ë“œ êµ¬ì¡°, ë¦¬íŒ©í† ë§

ê¸°ì¡´ì—ëŠ” ëª¨ë“  ë¡œì§ì´ í•œ í´ë˜ìŠ¤ì— ëª°ë ¤ ìˆì–´ ìœ ì§€ë³´ìˆ˜ê°€ ì–´ë ¤ì› ìŠµë‹ˆë‹¤.  
ì´ë²ˆì—ëŠ” **Controller / Service / Util**ë¡œ ì—­í• ì„ ë¶„ë¦¬í–ˆìŠµë‹ˆë‹¤.

### êµ¬ì¡°

```
src/main/java/org/prac/korailreserve/
â”œâ”€â”€ controller/
â”‚    â””â”€â”€ TicketController.java
â”œâ”€â”€ service/
â”‚    â”œâ”€â”€ TicketService.java
â”‚    â”œâ”€â”€ WebDriverService.java
â”‚    â”œâ”€â”€ KorailWebService.java
â”‚    â””â”€â”€ TicketSearchService.java
â””â”€â”€ util/
     â””â”€â”€ SmsSender.java
```

- **Controller**: API ì—”ë“œí¬ì¸íŠ¸ ë° íŒŒë¼ë¯¸í„° ê²€ì¦
- **Service**: ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§(ì˜ˆë§¤, ì›¹ë“œë¼ì´ë²„ ê´€ë¦¬, ì½”ë ˆì¼ ì›¹ì‚¬ì´íŠ¸ ìƒí˜¸ì‘ìš©, í‹°ì¼“ ê²€ìƒ‰/ì˜ˆì•½)
- **Util**: SMS ë°œì†¡ ë“± ë¶€ê°€ ê¸°ëŠ¥

---



## ì£¼ìš” ì½”ë“œ ìŠ¤ë‹ˆí« & ì„¤ëª…

### (1) WebDriver ì´ˆê¸°í™”

SafariDriver, ChromeDriverë¥¼ ì‚¬ìš©í•˜ë„ë¡ ë¶„ê¸°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.  
SafariëŠ” headless ëª¨ë“œê°€ ì•ˆ ë˜ë¯€ë¡œ ì°½ í¬ê¸° ì§€ì •ì´ í•„ìˆ˜ì…ë‹ˆë‹¤.

```java
// Safari WebDriver ì„¤ì •
@Service
public class WebDriverService {
    public WebDriver initializeWebDriver() {
        System.setProperty("webdriver.safari.driver", "/System/Cryptexes/App/usr/bin/safaridriver");
        WebDriver driver = new SafariDriver();
        driver.manage().window().setSize(new Dimension(1600, 1200));
        return driver;
    }
}
```

ğŸ’¡ Safari Driverì˜ ê²½ìš°, ì§ì ‘ ì„¤ì¹˜í•˜ì—¬ ì‹¤í–‰í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤. (Safariì˜ ê²½ìš° headless ëª¨ë“œë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.)  
ğŸ’¡ headless ëª¨ë“œ ì‚¬ìš©ì„ í•˜ì§€ ì•Šì„ ê²½ìš°ëŠ” ì˜µì…˜ë¶€ë¶„ì„ ì§€ìš°ë©´ ë©ë‹ˆë‹¤.  
ğŸ’¡ Selenium 4.0 ë²„ì „ ì´ìƒë¶€í„°ëŠ” WebDriverManagerë¥¼ ì‚¬ìš©í•˜ë©´ ë“œë¼ì´ë²„ê°€ ì €ì ˆë¡œ ì‹¤í–‰ë©ë‹ˆë‹¤.

```java
// Chrome WebDriver ì„¤ì •
@Service
public class WebDriverService {
    public WebDriver initializeWebDriver() {
        WebDriverManager.chromedriver().setup();
        ChromeOptions options = new ChromeOptions(); 
        options.addArguments("--headless");                        <-  chrome headless

        WebDriver driver = new ChromeDriver(options);
        // driver.manage().window().setSize(new Dimension(1600, 1200));  <-  chrome window size
        return driver;
    }
}
```


### (2) íŒì—…(React ëª¨ë‹¬) ë‹«ê¸°

íŒì—…ì´ ì™„ì „íˆ ì‚¬ë¼ì§ˆ ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¬ì§€ ì•Šìœ¼ë©´, ë’¤ì˜ ë²„íŠ¼ í´ë¦­ì´ ì‹¤íŒ¨í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```java
private void handleKorailPopup(WebDriver driver) {
    try {
        WebDriverWait wait = new WebDriverWait(driver, Duration.ofSeconds(10));
        WebElement popup = wait.until(ExpectedConditions.presenceOfElementLocated(
                By.cssSelector(".layerWrap.emer_pop")));
        WebElement closeButton = popup.findElement(By.cssSelector(".btn_by-blue.btn_pop-close"));
        closeButton.click();
        wait.until(ExpectedConditions.invisibilityOf(popup));
    } catch (Exception e) {
        System.out.println("íŒì—… ì—†ìŒ ë˜ëŠ” ì´ë¯¸ ë‹«í˜: " + e.getMessage());
    }
}
```

### (3) í‹°ì¼“ ê²€ìƒ‰ ë° ì˜ˆì•½

- ì¶œë°œ/ë„ì°©ì—­, ë‚ ì§œ, ì‹œê°„ ë“± ì¡°ê±´ì„ ì…ë ¥
- ì¡°ê±´ì— ë§ëŠ” ì—´ì°¨ê°€ ë‚˜íƒ€ë‚  ë•Œê¹Œì§€ ë°˜ë³µì ìœ¼ë¡œ ìƒˆë¡œê³ ì¹¨
- ì˜ˆì•½ ê°€ëŠ¥í•œ ì—´ì°¨ê°€ ìˆìœ¼ë©´ ë°”ë¡œ ì˜ˆì•½ ë²„íŠ¼ í´ë¦­

- ì¶”ê°€ì ìœ¼ë¡œ, ì´ì „ ì½”ë“œì—ì„œëŠ” 

```java
public boolean checkAndReserveTicket(...) {
    // ... ìƒëµ ...
    while (!isTicketFound && retryCount < maxRetries) {
        // ì—´ì°¨ ë¦¬ìŠ¤íŠ¸ ë¡œë”© ëŒ€ê¸°
        wait.until(ExpectedConditions.presenceOfElementLocated(By.cssSelector(".tckList.clear")));
        isTicketFound = findAndReserveAvailableTicket(...);
        if (!isTicketFound) {
            Thread.sleep(3000);
            driver.navigate().refresh();
            retryCount++;
        }
    }
    // ...
}
```

---

## ë§ˆì¹˜ë©°

ì½”ë ˆì¼ í™ˆí˜ì´ì§€ê°€ ë°”ë€Œë©´ í¬ë¡¤ëŸ¬ë„ ë°˜ë“œì‹œ ì ê²€/ìˆ˜ì •ì´ í•„ìš”í•©ë‹ˆë‹¤.  
Selenium ìë™í™”ëŠ” í•­ìƒ ì˜ˆì™¸ ìƒí™©(íŒì—…, ë¡œë”©, ë™ì  ìš”ì†Œ ë“±)ì— ëŒ€ë¹„í•´ì•¼ í•˜ë©°,  
ì¶©ë¶„í•œ waitì™€ ì˜ˆì™¸ ì²˜ë¦¬, ë‹¤ì–‘í•œ í™˜ê²½ì—ì„œì˜ í…ŒìŠ¤íŠ¸ê°€ í•„ìˆ˜ì…ë‹ˆë‹¤.

ì´ë²ˆ ë¦¬ë‰´ì–¼ ëŒ€ì‘ì„ í†µí•´  
- **ì½”ë“œ êµ¬ì¡°ë¥¼ MVCë¡œ ë¦¬íŒ©í† ë§**  
- **íŒì—…/ëª¨ë‹¬ ë“± ì‹¤ì „ ë¬¸ì œë¥¼ í•´ê²°**  
- **ìœ ì§€ë³´ìˆ˜ì„±ê³¼ ì•ˆì •ì„±ì„ ëª¨ë‘ ì¡ëŠ” ë°©ë²•**  

ì„ ê²½í—˜í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.

## ì‚¬ìš©ë²•

1. í”„ë¡œì íŠ¸ë¥¼ ë¡œì»¬ì—ì„œ ì‹¤í–‰í•©ë‹ˆë‹¤.
2. ë¸Œë¼ìš°ì €ì—ì„œ [`/swagger`](http://localhost:8080/swagger)ë¡œ ì ‘ì†í•©ë‹ˆë‹¤.
3. í•„ìš”í•œ ê°’ì„ ì…ë ¥í•˜ê³  APIë¥¼ ì‹¤í–‰í•˜ë©´ ìë™ ì˜ˆë§¤ê°€ ì§„í–‰ë©ë‹ˆë‹¤.

<img
  src="https://donghyeun-blog-images.s3.us-east-1.amazonaws.com/korailswagger.png"
  width="800"
/>

> Swagger UIë¥¼ í†µí•´ ëª¨ë“  ê¸°ëŠ¥ì„ ì†ì‰½ê²Œ í…ŒìŠ¤íŠ¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!

ì „ì²´ ì½”ë“œëŠ” [GitHub ë§í¬](https://github.com/donghyeun02/KTX_auto_reserve)ì— ê³µê°œë˜ì–´ ìˆìŠµë‹ˆë‹¤.  
ì§ˆë¬¸ì´ë‚˜ í”¼ë“œë°±ì€ ì´ë©”ì¼(donghyeun02@gmail.com)ë¡œ ë‚¨ê²¨ì£¼ì„¸ìš”!

> âš ï¸  í•´ë‹¹ í”„ë¡œì íŠ¸ëŠ” ê°œì¸ì ì¸ ìš©ë„ë¡œë§Œ ì‚¬ìš©í•˜ì—¬ ì£¼ì‹œê³ , ë¶ˆë²•ì ì¸ ê±°ë˜ë‚˜ í–‰ìœ„ëŠ” ì—„ê²©íˆ ê¸ˆì§€ë©ë‹ˆë‹¤.  
> ë³¸ í”„ë¡œì íŠ¸ ì‚¬ìš© ì‹œ ê´€ë ¨ ë²•ë¥ , ê·œì • ë° ì„œë¹„ìŠ¤ ì•½ê´€ì„ ì¤€ìˆ˜í•˜ëŠ” ê²ƒì€ ì‚¬ìš©ìì˜ ì±…ì„ì…ë‹ˆë‹¤.  
> ë³¸ í”„ë¡œì íŠ¸ì˜ ì‚¬ìš©ìœ¼ë¡œ ì¸í•œ ì–´ë– í•œ ë¬¸ì œì— ëŒ€í•´ì„œë„ ë³¸ í”„ë¡œì íŠ¸ ê°œë°œìëŠ” ì±…ì„ì„ ì§€ì§€ ì•ŠìŠµë‹ˆë‹¤.